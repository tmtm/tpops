<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>TPOPS</title>
    <link rel=stylesheet type="text/css" href="tommy.css">
    <link rev=made href="mailto:tommy@tmtm.org">
  </head>

  <body>
    <p><a href="README_en.html">[English page]</a></p>

    <h1>TPOPS</h1>

    <p>
      TPOPS は POP3 サーバです。RFC 1939 に準拠しています。
      Ruby で実装されています。
      サポートされているメールボックスは Maildir 形式です。
      POP ログイン名やメールアドレスなどのユーザ情報は MySQL のテーブルで管理することもできます。
    </p>

<!--
    <h2>ダウンロード</h2>
    <ul>
      <li><a href="tpops-0.6.tar.gz">tpops-0.6.tar.gz</a>
      <li><a href="tpops-0.5.4.tar.gz">tpops-0.5.4.tar.gz</a>
      <li><a href="tpops-0.5.3a.tar.gz">tpops-0.5.3a.tar.gz</a>
      <li><a href="tpops-0.5.2.tar.gz">tpops-0.5.2.tar.gz</a>
      <li><a href="tpops-0.5.1.tar.gz">tpops-0.5.1.tar.gz</a>
      <li><a href="tpops-0.5.0.tar.gz">tpops-0.5.0.tar.gz</a>
      <li><a href="tpops-0.4.8.tar.gz">tpops-0.4.8.tar.gz</a>
      <li><a href="tpops-0.4.7.tar.gz">tpops-0.4.7.tar.gz</a>
      <li><a href="tpops-0.4.6a.tar.gz">tpops-0.4.6a.tar.gz</a>
      <li><a href="tpops-0.4.6.tar.gz">tpops-0.4.6.tar.gz</a>
      <li><a href="tpops-0.4.5.tar.gz">tpops-0.4.5.tar.gz</a>
      <li><a href="tpops-0.4.4.tar.gz">tpops-0.4.4.tar.gz</a>
      <li><a href="tpops-0.4.3.tar.gz">tpops-0.4.3.tar.gz</a>
      <li><a href="tpops-0.4.2.tar.gz">tpops-0.4.2.tar.gz</a>
      <li><a href="tpops-0.4.1.tar.gz">tpops-0.4.1.tar.gz</a>
      <li><a href="tpops-0.4.tar.gz">tpops-0.4.tar.gz</a>
      <li><a href="tpops-0.3.3.tar.gz">tpops-0.3.3.tar.gz</a>
      <li><a href="tpops-0.3.2.tar.gz">tpops-0.3.2.tar.gz</a>
      <li><a href="tpops-0.3.1.tar.gz">tpops-0.3.1.tar.gz</a>
      <li><a href="tpops-0.3.tar.gz">tpops-0.3.tar.gz</a>
      <li><a href="tpops-0.2.2.tar.gz">tpops-0.2.2.tar.gz</a>
      <li><a href="tpops-0.2.1.tar.gz">tpops-0.2.1.tar.gz</a>
      <li><a href="tpops-0.2.tar.gz">tpops-0.2.tar.gz</a>
      <li><a href="tpops-0.1.tar.gz">tpops-0.1.tar.gz</a>
    </ul>
-->

    <h2>必要なもの</h2>
    <ul>
      <li><a href="http://www.ruby-lang.org">Ruby 1.6.8</a>
      <li><a href="http://www.mysql.com">MySQL 3.23.x</a> (MySQL 認証/メールボックスを使用する場合)
      <li><a href="/ruby/mysql/">Ruby/MySQL 0.2.4</a> (MySQL を使用する場合)
    </ul>

    <h2>インストール</h2>
    <ol>
      <li>適当なディレクトリに展開してください。

	<pre class="code">
# cd /usr/local
# tar xpfvz /tmp/tpops-0.6.tar.gz
# chown -R root:root tpops-0.6
# ln -s tpops-0.6 tpops
</pre>

      <li>tpops.conf を作成してください。サンプルが tpops.conf.sample にあります。
	<p>
	  設定できるパラメータは次の通りです。
	</p>

	<table frame="box" rules="all" summary="parameter">
	    <tr>
	      <th>パラメータ名<th>デフォルト値<th>意味
	    <tr>
	      <th colspan=3>共通パラメータ
	    <tr>
	      <td>$port<td>110
	      <td>ポート番号。
	    <tr>
	      <td>$hostname<td>`uname -n`.chomp
	      <td>自分のホスト名。
	    <tr>
	      <td>$connection_keep_time<td>3600
	      <td>
		最大接続維持時間(秒数)。
		接続開始からこの時間が経過すると、オペレーション中であっても強制的に接続を切断します。
	    <tr>
	      <td>$command_timeout<td>600
	      <td>
		コマンド待ち時間(秒数)。
		クライアントからこの時間入力がないと、接続を切断します。
	    <tr>
	      <td>$with_inetd<td>false
	      <td>inetd から起動するかどうかのフラグ。
	    <tr>
	      <td>$access_log<td>nil
	      <td>アクセスログファイル名。
	    <tr>
	      <td>$error_log<td>nil
	      <td>エラーログファイル名。
	    <tr>
	      <td>$pid_file<td>nil
	      <td>プロセスIDファイル名。
	    <tr>
	      <td>$syslog_facility<td>Syslog::LOG_MAIL
	      <td>
		syslog の facility。シンボルまたは数値。
		syslog を使用しない場合は nil を指定します。
	    <tr>
	      <td>$auth_type<td>'Passwd'
	      <td>
		認証タイプ。'Passwd' または 'MySQL' を指定します。
	    <tr>
	      <td>$error_interval<td>5
	      <td>クライアントにエラーを返す前に待つ秒数。
	    <tr>
	      <td>$min_servers<td>5
	      <td>最小待ち受けプロセス数。
	    <tr>
	      <td>$max_servers<td>50
	      <td>最大待ち受けプロセス数。
	    <tr>
	      <td>$max_use<td>100
	      <td>１プロセスあたりの最大処理数。
	    <tr>
	      <td>$max_idle<td>100
	      <td>この時間(秒数)接続がないと子プロセスが終了します。
	    <tr>
	      <td>$maildir_extended<td>true
	      <td>
		メッセージサイズの獲得に Maildir++ 形式のファイル名を使用するかどうか。
	    <tr>
	      <td>$maildir_use_filesize<td>true
	      <td>ファイルサイズをメッセージサイズとして使用するかどうか。
	    <tr>
	      <td>$user<td>nil
	      <td>
		プロセスのユーザ名。
		Passwd 認証時には、passwd 認証に root 権限が必要なシステムでは、このパラメータを設定すると認証できません。
	    <tr>
	      <td>$group<td>nil
	      <td>
		プロセスのグループ名。
	    <tr>
	      <th colspan=3>$auth_type == 'Passwd' 時に有効なパラメータ
	    <tr>
	      <td>$passwd_lock_dir<td>'/var/run/tpops'
	      <td>ロックファイル保持ディレクトリ。
	    <tr>
	      <td>$maildir<td>'Maildir'
	      <td>Maildir ディレクトリ(ホームディレクトリからの相対パス)。
	    <tr>
	      <td>$apop_passwd_file<td>nil
	      <td>APOP パスワードファイル。
	    <tr>
	      <th colspan=3>$auth_type == 'MySQL' 時に有効なパラメータ
	    <tr>
	      <td>$mysql_server<td>nil
	      <td>MySQLサーバホスト名。
	    <tr>
	      <td>$mysql_user<td>nil
	      <td>MySQL接続ユーザ。
	    <tr>
	      <td>$mysql_pass<td>nil
	      <td>MySQL接続ユーザのパスワード。
	    <tr>
	      <td>$mysql_db<td>nil
	      <td>MySQLデータベース名。
	    <tr>
	      <td>$mysql_auth_query
	      <td>'select login,passwd,uid,maildir from user where login="%s"'
	      <td>
		認証情報を取り出すためのクエリ。
		%s にはクライアントからのログイン名が入ります。
	</table>

      <li>$auth_type が 'MySQL' の場合

	<p>
	  MySQL に TPOPS 用のデータベースを作成し、tpops_auth-mysql.sql を使用してテーブルを作成してください。
	</p>
	<pre class="code">
% mysqladmin create tpops
% mysql tpops &lt; tpops_auth-mysql.sql
</pre>
    </ol>

    <h2>起動</h2>

    <ol>
      <li>スタンドアロンの場合(デフォルト)
	/usr/local/tpops/tpops を実行します。

      <li>inetd を使用する場合
	<p>
	  /etc/inetd.conf に次のように記述します。
	</p>
	<pre class="code">pop3	stream	tcp	nowait	root	/usr/local/tpops/tpops	tpops --inetd</pre>
	<p>
	  その後 inetd プロセスに HUP シグナルを通知します。
	</p>
    </ol>

    <h2>起動オプション</h2>

    <table frame="box" rules="all" summary="user table">
	<tr>
	  <th>オプション<th>意味
	<tr>
	  <td>-f <i>filename</i>
	  <td>
	    tpops.conf ではなく指定したファイルを読み込みます。
	<tr>
	  <td>--domain <i>domainname</i>
	  <td>
	    ログイン名に「@」「%」「+」のいずれも含まれてない場合に、
	    「@<i>domainname</i>」をログイン名に追加して認証を試みます。
	<tr>
	  <td>--fg
	  <td>
	    スタンドアロン時、フォアグランドで動作します。
	<tr>
	  <td>--port #
	  <td>
	    ポートを指定します。
	<tr>
	  <td>--debug
	  <td>
	    デバッグメッセージを syslog に出します。
	<tr>
	  <td>--version
	  <td>
	    バージョンを表示して終了します。
	<tr>
	  <td>--inetd
	  <td>
	    inetd から起動されるように動作します。
	<tr>
	  <td>--user <i>username</i>
	  <td>ユーザ名を指定します。
	<tr>
	  <td>--group <i>groupname</i>
	  <td>
	    グループ名を指定します。
	<tr>
	  <td>--pidfile <i>filename</i>
	  <td>
	    指定したファイルにプロセスIDを書き出します。
    </table>

    <h2>シグナル</h2>
    <p>
      SIGTERM を受信すると終了します。
      処理中の子プロセスは処理が終わるまで終了しません。
    </p>
    <p>
      SIGHUP を受信すると、子プロセスを終了させ、tpops.conf を再読み込みします。
      処理中の子プロセスは処理が終わるまで終了しません。
      tpops.conf ファイル中の記述よりもコマンドラインで指定したオプションが優先されます。
    </p>
    <p>
      SIGINT を受信すると終了します。
    </p>

    <h2>ユーザ登録</h2>

    <ol>
      <li>$auth_type が 'Passwd' の場合(デフォルト)
	<p>
	  OS にユーザを登録してください。
	  メールボックスは、ユーザのホームディレクトリ直下の 'Maildir' が使用されます。
	</p>
	<p>
	  APOP を使用する場合は、tpops.conf 内に $apop_passwd_file を設定してください。
	  APOP 使用時にはこのファイルから、パスワードが検索されます。
	  ここで指定するファイルの内容は、ログイン名をキーとしてプレーンパスワードを得られるような DBM 形式です。
	</p>
	<p>
	  DBM 形式ファイルの編集には、tpops_passwd コマンドを使用できます。
	</p>
	<table frame="box" rules="all" summary="tpops_passwd">
	    <tr><th>コマンド<th>説明
	    <tr><td>tpops_passwd <i>pwdfile</i> <i>id</i> <i>password</i><td>pwdfile に ID とパスワードを追加する
	    <tr><td>tpops_passwd -f <i>filename</i> <i>pwdfile</i><td>filename からIDとパスワードのリストを読み込み pwdfile に追加する
	    <tr><td>tpops_passwd -d <i>id</i> <i>pwdfile</i><td>pwdfile から ID を削除する
	    <tr><td>tpops_passwd -l <i>pwdfile</i><td>pwdfile 内の ID とパスワードをリストする
	</table>

      <li>$auth_type が 'MySQL' の場合
	<p>
	  user テーブルにユーザ情報を登録してください。
	</p>
	<table frame="box" rules="all" summary="user table">
	    <tr><th>フィールド名<th>値</tr>
	    <tr><td>uid<td>ユーザID(数値)</tr>
	    <tr><td>login<td>POPログイン名</tr>
	    <tr><td>passwd<td>POPパスワード</tr>
	    <tr><td>mail<td>メールアドレス</tr>
	    <tr><td>maildir<td>Maildir の場所</tr>
	</table>
    </ol>

    <h2>ログファイル</h2>

    <p>
      tpops.conf で $access_log を指定すると、ログアウト時に指定したファイルにログを書き込みます。
      ログの形式は次の通りです。
    </p>
    <pre class="code">接続元IP ログイン日 時刻 ログアウト日 時刻 ログイン名 ログイン時メッセージ数 ログイン時メッセージサイズ ログアウト時メッセージ数 ログアウト時メッセージサイズ</pre>
    <p>
      $syslog_facility を指定すると、指定したファシリティで syslog にログを書き出します。
      $syslog_facility はファシリティを表わす数値です。
      Syslog::LOG_MAIL という形式でも指定できます。
    </p>

    <h2>Maildir 形式を使用する場合の注意</h2>
    <p>
      qmail や Postfix の Maildir 形式では、メッセージの改行コードが "\n" としてファイルに格納されます。
      しかし POP プロトコルでは改行コードは "\r\n" に定められています。
      LIST コマンドなどで通知されるメッセージサイズも POP プロトコル上は、改行コードを２バイトとしてカウントする必要があります。
      そのため、メッセージサイズを得るだけでも、メッセージファイルを読み、改行コードを調べる必要があります。
    </p>
    <p>
      (qmail に付属の qmail-pop3d はこの処理をサボって、ファイルサイズを返しているため、RFC 的には正しくありません。)
    </p>
    <p>
      Maildir++ 形式のファイル名でメッセージを格納するメール配送エージェントを使用すれば、ファイル名にメッセージサイズが含められているので、ファイルの内容をチェックする必要がなく、高速に処理できます。
      メールファイルが Maildir++ 形式のファイル名の場合は、TPOPS は自動的にファイル名からサイズを得ようとします。この動作を無効にしたい場合は tpops.conf に「$maildir_extended = false」を設定してください。
    </p>
    <p>
      ファイル名が Maildir++ 形式でない場合は、ファイルサイズをメッセージサイズとして使用することで高速に処理しようとします(qmail と同じ手法)。
      この動作を無効にしたい場合は tpops.conf に「$maildir_use_filesize = false」を設定してください。
      ただし、メッセージサイズを調べるために、メッセージファイルの内容を読み出すため、遅くなります。注意してください。
    </p>

    <h2>注意</h2>
    <p>
      正常に動作することを期待して作られていますが、不具合がないことは保証できません。
      重要なメールデータが失われたとしても私は責任を負えません。
      十分テストした上でご使用ください。
    </p>

    <h2>ライセンス</h2>
    <p>
      このプログラムは Ruby ライセンスに従います。
    </p>

    <h2>履歴</h2>

    <dl>
      <dt>0.6
      <dd>
	<ul>
	  <li>tpops_passwd コマンドの追加。
	  <li>tpops-useradd コマンドの削除。
	  <li>$passwd_lock_dir のデフォルト値変更。
	  <li>$maildir パラメータの導入。
	  <li>SIGHUP 時にすべての設定パラメータを反映させるようにした。
	  <li>$apop_passwd_file の形式を BDB::Hash 形式から DBM 形式に変更。
	  <li>ロックファイルの形式を変更。
	  <li>ruby-shadow を不要にした。
	</ul>
      <dt>0.5.5	2004-03-18
      <dd>
	<ul>
	  <li>tserver 0.1.1 を使用(kill で終了しないことがあるバグに対応)
	  <li>Ruby 1.8.1 に対応
	</ul>
      <dt>0.5.4	2003-09-10
      <dd>
	<ul>
	  <li>syslog が「%」を含む文字列でエラーになっていたバグを修正
	</ul>
      <dt>0.5.3a	2003-04-27
      <dd>
	<ul>
	  <li>tserver 0.0.7 を使用
	</ul>
      <dt>0.5.3	2003-04-17
      <dd>
	<ul>
	  <li>$mysql_auth_query を配列にすることで、複数のクエリを記述できるようにした
	  <li>tserver 0.0.6 を使用
	</ul>
      <dt>0.5.2	2003-01-24
      <dd>
	<ul>
	  <li>スタンドアロン時に間違った ID を pid_file に記録していたバグを修正
	  <li>SIGTERM, SIGHUP で処理中の子プロセスを終了させないように変更
	  <li>SIGINT で子プロセスを強制的に終了させるように変更
	</ul>
      <dt>0.5.1	2003-01-18
      <dd>
	<ul>
	  <li>クライアント切断時にロックが残ったままになることがあるバグを修正
	  <li>SIGUSR1 が無視されるバグを修正
	  <li>$pid_file パラメータ, --pidfile オプション追加
	  <li>SIGHUP 時に $error_log を再オープンするように変更
	</ul>
      <dt>0.5.0	2002-12-04
      <dd>
	<ul>
	  <li>tpops.conf がなくても動くようにした
	  <li>tpops.conf 内のパラメータを $パラメータ に変更
	  <li>MySQL メールボックスの廃止
	  <li>TServer を使用して高速化
	  <li>$with_inetd のデフォルト値を false に変更
	  <li>$maildir_extended, $maildir_use_filesize のデフォルト値を true に変更
	  <li>スタンドアロン時も $error_log を有効にした
	  <li>コマンドラインオプションの追加
	</ul>
      <dt>0.4.8	2002-11-20
      <dd>
	<ul>
	  <li>APOP認証失敗時にログにユーザ名が出力されないバグを修正
	  <li>syslog 機能追加
	</ul>
      <dt>0.4.7	2002-11-07
      <dd>
	<ul>
	  <li>CommandTimeout,ConnectionKeepTime タイマが働かないことがあるバグを修正
	  <li>ログイン時とログアウト時のメール数とサイズをログに記録するようにした
	  <li>ロックしたプロセスが存在しない場合にロック解除するようにした
	  <li>エラーファイルに時刻を出力するようにした
	</ul>
      <dt>0.4.6a	2002-08-16
      <dd>
	<ul>
	  <li>クライアントが接続を切断した時に無限ループになるバグを修正
	</ul>
      <dt>0.4.6	2002-08-16
      <dd>
	<ul>
	  <li>メールボックスが ENOENT 以外のエラーの場合に異常終了するようにした
	  <li>クライアントからの１行の入力が 1024バイトを超えると接続を切断するようにした
	  <li>ログインに成功しなくてもログを出力するようにした
	</ul>
      <dt>0.4.5	2002-08-01
      <dd>
	<ul>
	  <li>ログが取れないことがあるバグを修正
	  <li>ごく稀に EINTR エラーになることがあるバグを修正
	  <li>--domain オプションを追加
	</ul>
      <dt>0.4.4	2002-07-03
      <dd>
	<ul>
	  <li>TOP がエラーになるバグを修正
	  <li>MaildirUseFileSize が未定義になるバグを修正
	</ul>
      <dt>0.4.3	2002-06-27
      <dd>
	<ul>
	  <li>大きなメールの処理速度を向上
	</ul>
      <dt>0.4.2	2002-04-21
      <dd>
	<ul>
	  <li>Maildir++ 形式のファイル名を扱えるようにした (MaildirExtended)
	  <li>MaildirCRLF を MaildirUseFileSize に変更
	  <li>tpops-pipe: quota に引っ掛かったユーザ以外のメールが配送されないバグを修正
	</ul>
      <dt>0.4.1   2002-04-11
      <dd>
	<ul>
	  <li>大きなメールの RETR/TOP 時の速度とメモリ効率を向上
	</ul>
      <dt>0.4     2002-03-21
      <dd>
	<ul>
	  <li>認証方式とメールボックス方式を本体から分離
	  <li>OS の /etc/passwd をユーザ認証に使用できるようにした
	  <li>MySQL をオプションにした
	</ul>
      <dt>0.3.3   2002-02-27
      <dd>
	<ul>
	  <li>POP before SMTP の仕組みのバグを修正
	  <li>TOP がおかしな結果を返していたバグを修正
	</ul>
      <dt>0.3.2   2002-02-25
      <dd>
	<ul>
	  <li>Log ファイルが壊れる可能性があったバグを修正
	  <li>POP before SMTP の仕組みを導入
	  <li>RETR/TOP 時には MaildirCRLF の値に関わらず "\r\n" のデータを返すようにした（MaildirCRLF はメッセージサイズ値だけに影響する）。
	</ul>
      <dt>0.3.1   2002-01-29
      <dd>
	<ul>
	  <li>WithInetd 時のエラー出力をファイルに変更
	</ul>
      <dt>0.3     2002-01-25
      <dd>
	<ul>
	  <li>WithInetd パラメータの導入
	  <li>LogFile パラメータの導入
	</ul>
      <dt>0.2.2   2001-12-28
      <dd>
	<ul>
	  <li>若干の高速化
	  <li>QUIT の応答時のエラーを無視
	</ul>
      <dt>0.2.1   2001-08-01
      <dd>
	<ul>
	  <li>パスワードが MySQL のログに残らないようにした
	  <li>AuthQuery パラメータの導入
	</ul>
      <dt>0.2     2001-07-12
      <dd>
	<ul>
	  <li>Maildir 形式を扱えるようにした
	</ul>
      <dt>0.1     2001-05-20
      <dd>
	<ul>
	  <li>公開
	</ul>
    </dl>
    <hr>
    <address><a href="mailto:tommy@tmtm.org">とみたまさひろ</a></address>
    <p>
<!-- Created: Mon Jul 30 00:59:27 JST 2001 -->
<!-- hhmts start -->
Last modified: Mon Mar 22 11:39:31 JST 2004
<!-- hhmts end -->
    </p>
  </body>
</html>
