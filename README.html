<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="Content-Style-Type" content="text/css">
    <title>TPOPS</title>
    <link rel=stylesheet type="text/css" href="tommy.css">
    <link rev=made href="mailto:tommy@tmtm.org">
  </head>

  <body>
    <p><a href="README_en.html">[English page]</a></p>

    <h1>TPOPS</h1>

    <p>
      TPOPS は POP3 サーバです。RFC 1939 に準拠しています。
      Ruby で実装されています。
      サポートされているメールボックスは Maildir 形式です。
      POP ログイン名やメールアドレスなどのユーザ情報は MySQL のテーブルで管理することもできます。
    </p>

<!--
    <h2>ダウンロード</h2>
    <ul>
      <li><a href="tpops-0.6.tar.gz">tpops-0.6.tar.gz</a>
      <li><a href="tpops-0.5.4.tar.gz">tpops-0.5.4.tar.gz</a>
      <li><a href="tpops-0.5.3a.tar.gz">tpops-0.5.3a.tar.gz</a>
      <li><a href="tpops-0.5.2.tar.gz">tpops-0.5.2.tar.gz</a>
      <li><a href="tpops-0.5.1.tar.gz">tpops-0.5.1.tar.gz</a>
      <li><a href="tpops-0.5.0.tar.gz">tpops-0.5.0.tar.gz</a>
      <li><a href="tpops-0.4.8.tar.gz">tpops-0.4.8.tar.gz</a>
      <li><a href="tpops-0.4.7.tar.gz">tpops-0.4.7.tar.gz</a>
      <li><a href="tpops-0.4.6a.tar.gz">tpops-0.4.6a.tar.gz</a>
      <li><a href="tpops-0.4.6.tar.gz">tpops-0.4.6.tar.gz</a>
      <li><a href="tpops-0.4.5.tar.gz">tpops-0.4.5.tar.gz</a>
      <li><a href="tpops-0.4.4.tar.gz">tpops-0.4.4.tar.gz</a>
      <li><a href="tpops-0.4.3.tar.gz">tpops-0.4.3.tar.gz</a>
      <li><a href="tpops-0.4.2.tar.gz">tpops-0.4.2.tar.gz</a>
      <li><a href="tpops-0.4.1.tar.gz">tpops-0.4.1.tar.gz</a>
      <li><a href="tpops-0.4.tar.gz">tpops-0.4.tar.gz</a>
      <li><a href="tpops-0.3.3.tar.gz">tpops-0.3.3.tar.gz</a>
      <li><a href="tpops-0.3.2.tar.gz">tpops-0.3.2.tar.gz</a>
      <li><a href="tpops-0.3.1.tar.gz">tpops-0.3.1.tar.gz</a>
      <li><a href="tpops-0.3.tar.gz">tpops-0.3.tar.gz</a>
      <li><a href="tpops-0.2.2.tar.gz">tpops-0.2.2.tar.gz</a>
      <li><a href="tpops-0.2.1.tar.gz">tpops-0.2.1.tar.gz</a>
      <li><a href="tpops-0.2.tar.gz">tpops-0.2.tar.gz</a>
      <li><a href="tpops-0.1.tar.gz">tpops-0.1.tar.gz</a>
    </ul>
-->

    <h2>必要なもの</h2>
    <ul>
      <li><a href="http://www.ruby-lang.org">Ruby 1.6.8</a>
      <li><a href="http://www.mysql.com">MySQL 3.23.x</a> (MySQL 認証/メールボックスを使用する場合)
      <li><a href="/ruby/mysql/">Ruby/MySQL 0.2.4</a> (MySQL を使用する場合)
    </ul>

    <h2>インストール</h2>
    <ol>
      <li>適当なディレクトリに展開してください。

	<pre class="code">
# cd /usr/local
# tar xpfvz /tmp/tpops-0.6.tar.gz
# chown -R root:root tpops-0.6
# ln -s tpops-0.6 tpops
</pre>

      <li>必要に応じて tpops.conf を編集してください。
	<p>
	  設定できるパラメータは次の通りです。
	  これらのパラメータはコマンドライン上で --parameter=value としても記述できます。
	  コマンドラインでの指定が優先されます。
	</p>

	<table frame="box" rules="all" summary="parameter">
	    <tr>
	      <th>パラメータ名<th>デフォルト値<th>意味
	    <tr>
	      <th colspan=3>標準パラメータ
	    <tr>
	      <td>config<td>なし(tpopsと同じディレクトリの tpops.conf)
	      <td>設定ファイルを指定します。通常はコマンドラインで指定します。
		設定ファイル中で指定してもおそらく意味はないでしょう。
	    <tr>
	      <td>port または p<td>110
	      <td>tpops が listen するポート番号。
		「ホスト名:ポート番号」の形式でホスト名を指定した時は、そのアドレスだけで listen します。
	    <tr>
	      <td>hostname<td>なし(「uname -n」の結果)
	      <td>クライアントの接続時に最初に返されるメッセージ中に含まれるホスト名。
	    <tr>
	      <td>connection-keep-time<td>3600
	      <td>
		最大接続維持時間(秒数)。
		接続開始からこの時間が経過すると、オペレーション中であっても強制的に接続を切断します。
	    <tr>
	      <td>command-timeout<td>600
	      <td>
		コマンド待ち時間(秒数)。
		クライアントからこの時間入力がないと、接続を切断します。
	    <tr>
	      <td>inetd<td>なし
	      <td>指定されている場合は inetd から起動されたものとして動作します。
	    <tr>
	      <td>fg<td>なし
	      <td>指定されている場合はフォアグラウンドで動作します。
	    <tr>
	      <td>version<td>なし
	      <td>指定されている場合はバージョン情報を表示して終了します。
	    <tr>
	      <td>debug<td>なし
	      <td>指定されている場合はクライアントのコマンドとサーバの応答をログに記録します。
	    <tr>
	      <td>access-log<td>なし
	      <td>アクセスログファイル名。
	    <tr>
	      <td>error-log<td>なし
	      <td>エラーログファイル名。
	    <tr>
	      <td>pid-file<td>なし
	      <td>プロセスIDを記録するファイル名。
	    <tr>
	      <td>user または u<td>なし(親プロセスと同じ)
	      <td>子プロセスの UID。passwd 認証に root 権限が必要なシステムでは、このパラメータを設定すると認証できません。
	    <tr>
	      <td>group または g<td>なし(親プロセスと同じ)
	      <td>子プロセスの GID。
	    <tr>
	      <td>syslog<td>mail
	      <td>syslog ファシリティ名。syslog に記録しない場合は「none」を指定します。
	    <tr>
	      <td>auth-type<td>passwd
	      <td>
		ユーザ認証方式。passwd, mysql のいずれかを指定します。
	    <tr>
	      <td>domain<td>
	      <td>ログイン名に「@」「%」「+」のいずれも含まれてない場合に、「@domainname」をログイン名に追加して認証を試みます。
	    <tr>
	      <td>error-interval<td>5
	      <td>クライアントからのコマンドがエラーになった場合に、エラーを返す前に遅延する秒数。
	    <tr>
	      <td>min-servers<td>5
	      <td>最小子プロセス数。子プロセス数がこの値以下になると、この値になるまで子プロセスが起動されます。
	    <tr>
	      <td>max-servers<td>50
	      <td>最大子プロセス数。子プロセス数はこの値以上にはなりません。
	    <tr>
	      <td>max-use<td>100
	      <td>子プロセスが処理する接続数の最大値。この値を超えると子プロセスは終了します。
	    <tr>
	      <td>max-idle<td>100
	      <td>最大接続待ち時間。接続終了後、この時間内に新たな接続がないと子プロセスは終了します。
	    <tr>
	      <td>maildir-use-filesize<td>yes
	      <td>Maildir 形式で保存されているメールファイルのサイズを、メールのサイズとして扱います。
		RFCに従わなくなる可能性があるので注意。
	    <tr>
	      <td>maildir-extended<td>yes
	      <td>Maildir 形式で保存されているメールファイルのファイル名中に「S=数値」があれば、それをメールのサイズとして扱います。
		maildir-use-filesize よりも優先されます。
		RFCに従わなくなる可能性があるので注意。
	    <tr>
	      <td>maildir-lock<td>yes
	      <td>メールボックスをロックします。ログイン中は同じメールボックスを使用する ID ではログインできません。
	    <tr>
	      <th colspan=3>auth-type = passwd 時に有効なパラメータ
	    <tr>
	      <td>apop-passwd-file<td>なし
	      <td>APOP 認証時に使用される ID とパスワードの対が DBM 形式で格納されたファイル名。指定された場合は、APOP が使用できます。
	    <tr>
	      <td>maildir<td>Maildir
	      <td>Maildir 形式のメール格納ディレクトリのユーザのホームディレクトリからの相対パス。
	    <tr>
	      <th colspan=3>auth-type = mysql 時に有効なパラメータ
	    <tr>
	      <td>mysql-server<td>なし
	      <td>MySQLサーバ名。
	    <tr>
	      <td>mysql-user<td>なし
	      <td>MySQLログインユーザ名。
	    <tr>
	      <td>mysql-pass<td>なし
	      <td>MySQLログインパスワード。
	    <tr>
	      <td>mysql-db<td>なし
	      <td>MySQLデータベース名。
	    <tr>
	      <td>mysql-auth-query
	      <td>select login,passwd,maildir from user where login="%s"
	      <td>
		ログイン名,パスワード,Maildir を取り出すためのクエリ文字列。
		「%s」はクライアントから渡されたログイン名に置き換えられます。
	</table>

      <li>auth_type = mysql の場合

	<p>
	  MySQL に TPOPS 用のデータベースを作成し、tpops_auth-mysql.sql を使用してテーブルを作成してください。
	</p>
	<pre class="code">
% mysqladmin create tpops
% mysql tpops &lt; tpops_auth-mysql.sql
</pre>
    </ol>

    <h2>起動</h2>

    <ol>
      <li>スタンドアロンの場合(デフォルト)
	/usr/local/tpops/tpops を実行します。

      <li>inetd を使用する場合
	<p>
	  /etc/inetd.conf に次のように記述します。
	</p>
	<pre class="code">pop3	stream	tcp	nowait	root	/usr/local/tpops/tpops	tpops --inetd</pre>
	<p>
	  その後 inetd プロセスに HUP シグナルを通知します。
	</p>
    </ol>

    <h2>シグナル</h2>
    <p>
      SIGTERM を受信すると終了します。
      処理中の子プロセスは処理が終わるまで終了しません。
    </p>
    <p>
      SIGHUP を受信すると、子プロセスを終了させ、tpops.conf を再読み込みします。
      処理中の子プロセスは処理が終わるまで終了しません。
      tpops.conf ファイル中の記述よりもコマンドラインで指定したオプションが優先されます。
    </p>
    <p>
      SIGINT を受信すると終了します。
    </p>

    <h2>ユーザ登録</h2>

    <ol>
      <li>auth-type = passwd の場合(デフォルト)
	<p>
	  OS にユーザを登録してください。
	  メールボックスは、ユーザのホームディレクトリ直下の 'Maildir' が使用されます。
	</p>
	<p>
	  APOP を使用する場合は、tpops.conf 内に apop-passwd-file を設定してください。
	  APOP 使用時にはこのファイルから、パスワードが検索されます。
	  ここで指定するファイルの内容は、ログイン名をキーとしてプレーンパスワードを得られるような DBM 形式です。
	</p>
	<p>
	  DBM 形式ファイルの編集には、tpops_passwd コマンドを使用できます。
	</p>
	<table frame="box" rules="all" summary="tpops_passwd">
	    <tr><th>コマンド<th>説明
	    <tr><td>tpops_passwd <i>pwdfile</i> <i>id</i> <i>password</i><td>pwdfile に ID とパスワードを追加する
	    <tr><td>tpops_passwd -f <i>filename</i> <i>pwdfile</i><td>filename からIDとパスワードのリストを読み込み pwdfile に追加する
	    <tr><td>tpops_passwd -d <i>id</i> <i>pwdfile</i><td>pwdfile から ID を削除する
	    <tr><td>tpops_passwd -l <i>pwdfile</i><td>pwdfile 内の ID とパスワードをリストする
	</table>

      <li>auth-type = mysql の場合
	<p>
	  user テーブルにユーザ情報を登録してください。
	</p>
	<table frame="box" rules="all" summary="user table">
	    <tr><th>フィールド名<th>値</tr>
	    <tr><td>uid<td>ユーザID(数値)</tr>
	    <tr><td>login<td>POPログイン名</tr>
	    <tr><td>passwd<td>POPパスワード</tr>
	    <tr><td>mail<td>メールアドレス</tr>
	    <tr><td>maildir<td>Maildir の場所</tr>
	</table>
    </ol>

    <h2>ログファイル</h2>

    <p>
      tpops.conf で access-log を指定すると、ログアウト時に指定したファイルにログを書き込みます。
      ログの形式は次の通りです。
    </p>
    <pre class="code">接続元IP ログイン日 時刻 ログアウト日 時刻 ログイン名 ログイン時メッセージ数 ログイン時メッセージサイズ ログアウト時メッセージ数 ログアウト時メッセージサイズ</pre>
    <p>
      syslog を指定すると、指定したファシリティで syslog にログを書き出します。
      syslog はファシリティを表わす文字列です。
    </p>

    <h2>Maildir 形式を使用する場合の注意</h2>
    <p>
      qmail や Postfix の Maildir 形式では、メッセージの改行コードが "\n" としてファイルに格納されます。
      しかし POP プロトコルでは改行コードは "\r\n" に定められています。
      LIST コマンドなどで通知されるメッセージサイズも POP プロトコル上は、改行コードを２バイトとしてカウントする必要があります。
      そのため、メッセージサイズを得るだけでも、メッセージファイルを読み、改行コードを調べる必要があります。
    </p>
    <p>
      (qmail に付属の qmail-pop3d はこの処理をサボって、ファイルサイズを返しているため、RFC 的には正しくありません。)
    </p>
    <p>
      Maildir++ 形式のファイル名でメッセージを格納するメール配送エージェントを使用すれば、ファイル名にメッセージサイズが含められているので、ファイルの内容をチェックする必要がなく、高速に処理できます。
      メールファイルが Maildir++ 形式のファイル名の場合は、TPOPS は自動的にファイル名からサイズを得ようとします。この動作を無効にしたい場合は tpops.conf に「maildir-extended = no」を設定してください。
    </p>
    <p>
      ファイル名が Maildir++ 形式でない場合は、ファイルサイズをメッセージサイズとして使用することで高速に処理しようとします(qmail と同じ手法)。
      この動作を無効にしたい場合は tpops.conf に「maildir-use-filesize = no」を設定してください。
      ただし、メッセージサイズを調べるために、メッセージファイルの内容を読み出すため、遅くなります。注意してください。
    </p>

    <h2>注意</h2>
    <p>
      正常に動作することを期待して作られていますが、不具合がないことは保証できません。
      重要なメールデータが失われたとしても私は責任を負えません。
      十分テストした上でご使用ください。
    </p>

    <h2>ライセンス</h2>
    <p>
      このプログラムは Ruby ライセンスに従います。
    </p>

    <h2>履歴</h2>

    <dl>
      <dt>0.6 2004-06-11
      <dd>
	<ul>
	  <li>コマンドラインオプションを変更。
	  <li>コンフィグファイルの形式を変更(Rubyスクリプトではなくなった)。
	  <li>tpops_passwd コマンドの追加。
	  <li>tpops-useradd コマンドの削除。
	  <li>passwd-lock-dir のデフォルト値変更。
	  <li>maildir パラメータの導入。
	  <li>SIGHUP 時にすべての設定パラメータを反映させるようにした。
	  <li>apop-passwd-file の形式を BDB::Hash 形式から DBM 形式に変更。
	  <li>ロックファイルの形式を変更。
	  <li>ruby-shadow を不要にした。
	  <li>tserver 0.2 を使用。
	  <li>plugin ディレクトリの作成。
	  <li>mysql-auth-query の検索結果を変更。
	  <li>ログイン時に new から cur にメールを移動するようにした。
	  <li>RETR したメールに S フラグをつけるようにした。
	  <li>LAST コマンド対応。
	</ul>
      <dt>0.5.5	2004-03-18
      <dd>
	<ul>
	  <li>tserver 0.1.1 を使用(kill で終了しないことがあるバグに対応)
	  <li>Ruby 1.8.1 に対応
	</ul>
      <dt>0.5.4	2003-09-10
      <dd>
	<ul>
	  <li>syslog が「%」を含む文字列でエラーになっていたバグを修正
	</ul>
      <dt>0.5.3a	2003-04-27
      <dd>
	<ul>
	  <li>tserver 0.0.7 を使用
	</ul>
      <dt>0.5.3	2003-04-17
      <dd>
	<ul>
	  <li>$mysql_auth_query を配列にすることで、複数のクエリを記述できるようにした
	  <li>tserver 0.0.6 を使用
	</ul>
      <dt>0.5.2	2003-01-24
      <dd>
	<ul>
	  <li>スタンドアロン時に間違った ID を pid_file に記録していたバグを修正
	  <li>SIGTERM, SIGHUP で処理中の子プロセスを終了させないように変更
	  <li>SIGINT で子プロセスを強制的に終了させるように変更
	</ul>
      <dt>0.5.1	2003-01-18
      <dd>
	<ul>
	  <li>クライアント切断時にロックが残ったままになることがあるバグを修正
	  <li>SIGUSR1 が無視されるバグを修正
	  <li>$pid_file パラメータ, --pidfile オプション追加
	  <li>SIGHUP 時に $error_log を再オープンするように変更
	</ul>
      <dt>0.5.0	2002-12-04
      <dd>
	<ul>
	  <li>tpops.conf がなくても動くようにした
	  <li>tpops.conf 内のパラメータを $パラメータ に変更
	  <li>MySQL メールボックスの廃止
	  <li>TServer を使用して高速化
	  <li>$with_inetd のデフォルト値を false に変更
	  <li>$maildir_extended, $maildir_use_filesize のデフォルト値を true に変更
	  <li>スタンドアロン時も $error_log を有効にした
	  <li>コマンドラインオプションの追加
	</ul>
      <dt>0.4.8	2002-11-20
      <dd>
	<ul>
	  <li>APOP認証失敗時にログにユーザ名が出力されないバグを修正
	  <li>syslog 機能追加
	</ul>
      <dt>0.4.7	2002-11-07
      <dd>
	<ul>
	  <li>CommandTimeout,ConnectionKeepTime タイマが働かないことがあるバグを修正
	  <li>ログイン時とログアウト時のメール数とサイズをログに記録するようにした
	  <li>ロックしたプロセスが存在しない場合にロック解除するようにした
	  <li>エラーファイルに時刻を出力するようにした
	</ul>
      <dt>0.4.6a	2002-08-16
      <dd>
	<ul>
	  <li>クライアントが接続を切断した時に無限ループになるバグを修正
	</ul>
      <dt>0.4.6	2002-08-16
      <dd>
	<ul>
	  <li>メールボックスが ENOENT 以外のエラーの場合に異常終了するようにした
	  <li>クライアントからの１行の入力が 1024バイトを超えると接続を切断するようにした
	  <li>ログインに成功しなくてもログを出力するようにした
	</ul>
      <dt>0.4.5	2002-08-01
      <dd>
	<ul>
	  <li>ログが取れないことがあるバグを修正
	  <li>ごく稀に EINTR エラーになることがあるバグを修正
	  <li>--domain オプションを追加
	</ul>
      <dt>0.4.4	2002-07-03
      <dd>
	<ul>
	  <li>TOP がエラーになるバグを修正
	  <li>MaildirUseFileSize が未定義になるバグを修正
	</ul>
      <dt>0.4.3	2002-06-27
      <dd>
	<ul>
	  <li>大きなメールの処理速度を向上
	</ul>
      <dt>0.4.2	2002-04-21
      <dd>
	<ul>
	  <li>Maildir++ 形式のファイル名を扱えるようにした (MaildirExtended)
	  <li>MaildirCRLF を MaildirUseFileSize に変更
	  <li>tpops-pipe: quota に引っ掛かったユーザ以外のメールが配送されないバグを修正
	</ul>
      <dt>0.4.1   2002-04-11
      <dd>
	<ul>
	  <li>大きなメールの RETR/TOP 時の速度とメモリ効率を向上
	</ul>
      <dt>0.4     2002-03-21
      <dd>
	<ul>
	  <li>認証方式とメールボックス方式を本体から分離
	  <li>OS の /etc/passwd をユーザ認証に使用できるようにした
	  <li>MySQL をオプションにした
	</ul>
      <dt>0.3.3   2002-02-27
      <dd>
	<ul>
	  <li>POP before SMTP の仕組みのバグを修正
	  <li>TOP がおかしな結果を返していたバグを修正
	</ul>
      <dt>0.3.2   2002-02-25
      <dd>
	<ul>
	  <li>Log ファイルが壊れる可能性があったバグを修正
	  <li>POP before SMTP の仕組みを導入
	  <li>RETR/TOP 時には MaildirCRLF の値に関わらず "\r\n" のデータを返すようにした（MaildirCRLF はメッセージサイズ値だけに影響する）。
	</ul>
      <dt>0.3.1   2002-01-29
      <dd>
	<ul>
	  <li>WithInetd 時のエラー出力をファイルに変更
	</ul>
      <dt>0.3     2002-01-25
      <dd>
	<ul>
	  <li>WithInetd パラメータの導入
	  <li>LogFile パラメータの導入
	</ul>
      <dt>0.2.2   2001-12-28
      <dd>
	<ul>
	  <li>若干の高速化
	  <li>QUIT の応答時のエラーを無視
	</ul>
      <dt>0.2.1   2001-08-01
      <dd>
	<ul>
	  <li>パスワードが MySQL のログに残らないようにした
	  <li>AuthQuery パラメータの導入
	</ul>
      <dt>0.2     2001-07-12
      <dd>
	<ul>
	  <li>Maildir 形式を扱えるようにした
	</ul>
      <dt>0.1     2001-05-20
      <dd>
	<ul>
	  <li>公開
	</ul>
    </dl>
    <hr>
    <address><a href="mailto:tommy@tmtm.org">とみたまさひろ</a></address>
    <p>
<!-- Created: Mon Jul 30 00:59:27 JST 2001 -->
<!-- hhmts start -->
Last modified: Fri Jun 11 01:13:35 JST 2004
<!-- hhmts end -->
    </p>
  </body>
</html>
